<div class="container mt-4">
  <h4 class="mb-4">ğŸ‘¥ Manage Assistants</h4>

  <!-- Global alert -->
  <div id="settingsAlert" class="alert d-none" role="alert"></div>

  <!-- ADD NEW ASSISTANT -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white">â• Add New Assistant</div>
    <div class="card-body">
      <form id="addAssistantForm">
        <div class="row g-2">
          <div class="col-md-4">
            <input type="text" name="username" class="form-control" placeholder="Username" required>
          </div>
          <div class="col-md-4">
            <input type="password" name="password" class="form-control" placeholder="Password" required>
          </div>
          <div class="col-md-4">
            <button type="submit" class="btn btn-success w-100">Add Assistant</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- CHANGE ADMIN PASSWORD -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-dark text-white">ğŸ” Change Admin Password</div>
    <div class="card-body">
      <form id="changeAdminPasswordForm">
        <div class="row g-2">
          <div class="col-md-6">
            <input type="password" name="new_password" class="form-control" placeholder="New admin password" required>
          </div>
          <div class="col-md-6">
            <button type="submit" class="btn btn-warning w-100">Update Admin Password</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- MANAGE ASSISTANTS -->
  <div class="card shadow-sm">
    <div class="card-header bg-dark text-white">Assistant Management</div>
    <div class="card-body">
      {% for assistant in assistants %}
      <div class="border rounded p-4 mb-4 shadow-sm bg-light">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
          <h5 class="fw-bold mb-2">
            {{ assistant.name or "Assistant" }} <small class="text-muted">({{ assistant.username }})</small>
          </h5>
          <span class="badge bg-{{ 'success' if assistant.status == 'active' else 'secondary' }}">
            {{ assistant.status }}
          </span>
        </div>

        <!-- Change Assistant Password -->
        <form class="assistant-password-form mt-3" data-id="{{ assistant._id }}">
          <label class="form-label mb-1 fw-medium">Change Password</label>
          <div class="input-group" style="max-width: 350px;">
            <input type="password" name="new_password" placeholder="New password" class="form-control" required>
            <button type="submit" class="btn btn-warning">Update</button>
          </div>
        </form>

        <!-- Key Permission Toggles -->
        <div class="mt-4">
          <h6 class="fw-semibold mb-2">Permissions</h6>
          <div class="row row-cols-1 row-cols-md-2 g-4">
            {% for perm in ['view_dashboard', 'approve_orders'] %}
            <div class="col">
              <div class="form-check form-switch form-check-lg">
                <input class="form-check-input setting-toggle" type="checkbox"
                       id="perm_{{ perm }}_{{ assistant._id }}"
                       data-setting="{{ perm }}"
                       {% if settings.get(perm) %}checked{% endif %}>
                <label class="form-check-label fs-5 fw-semibold text-capitalize" for="perm_{{ perm }}_{{ assistant._id }}">
                  {{ perm.replace('_', ' ') }}
                </label>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>

        <!-- Lock Account -->
        <div class="mt-4">
          <h6 class="fw-semibold mb-2">Account Lock</h6>
          <div class="form-check form-switch form-check-lg">
            <input class="form-check-input lock-toggle" type="checkbox"
                   id="lock_{{ assistant._id }}"
                   data-id="{{ assistant._id }}"
                   {% if assistant.status != 'active' %}checked{% endif %}>
            <label class="form-check-label fs-5 fw-semibold" for="lock_{{ assistant._id }}">
              Lock this assistant's account
            </label>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>


<!-- SETTINGS JS -->
<script>
  const showAlert = (message, type = 'success') => {
    const alertBox = document.getElementById('settingsAlert');
    alertBox.className = `alert alert-${type}`;
    alertBox.textContent = message;
    alertBox.classList.remove('d-none');
    setTimeout(() => alertBox.classList.add('d-none'), 4000);
  };

  // Add new assistant
  document.getElementById('addAssistantForm').addEventListener('submit', function (e) {
    e.preventDefault();
    const formData = new FormData(this);
    fetch('/admin/settings/add_assistant', {
      method: 'POST',
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      showAlert(data.message, data.success ? 'success' : 'danger');
      if (data.success) window.location.reload();
    })
    .catch(() => showAlert('Error adding assistant.', 'danger'));
  });

  // Change admin password
  document.getElementById('changeAdminPasswordForm').addEventListener('submit', function (e) {
    e.preventDefault();
    const formData = new FormData(this);
    fetch('/admin/settings/change_password', {
      method: 'POST',
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      showAlert(data.message, data.success ? 'success' : 'danger');
      if (data.success) this.reset();
    })
    .catch(() => showAlert('Error changing admin password.', 'danger'));
  });

  // Update assistant password
  document.querySelectorAll('.assistant-password-form').forEach(form => {
    form.addEventListener('submit', function (e) {
      e.preventDefault();
      const id = this.dataset.id;
      const formData = new FormData(this);
      fetch(`/admin/settings/assistant/${id}/change_password`, {
        method: 'POST',
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        showAlert(data.message, data.success ? 'success' : 'danger');
        if (data.success) this.reset();
      })
      .catch(() => showAlert('Error updating assistant password.', 'danger'));
    });
  });

  // Update permission toggles
  document.querySelectorAll('.setting-toggle').forEach(input => {
    input.addEventListener('change', function () {
      fetch('/admin/settings/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          setting: this.dataset.setting,
          value: this.checked
        })
      })
      .then(res => res.json())
      .then(data => {
        if (!data.success) {
          showAlert(data.message || "Failed to update setting.", 'danger');
        }
      })
      .catch(() => showAlert("System error while updating setting.", 'danger'));
    });
  });
    // Toggle lock account
  document.querySelectorAll('.lock-toggle').forEach(input => {
    input.addEventListener('change', function () {
      const assistantId = this.dataset.id;
      const locked = this.checked;
      fetch(`/admin/settings/assistant/${assistantId}/lock`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ locked })
      })
      .then(res => res.json())
      .then(data => {
        showAlert(data.message, data.success ? 'success' : 'danger');
        if (data.success) setTimeout(() => window.location.reload(), 1000);
      })
      .catch(() => showAlert('Error updating lock status.', 'danger'));
    });
  });

</script>
