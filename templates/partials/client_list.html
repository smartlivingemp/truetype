<!-- Updated Client List HTML -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Client List</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
 <style>
  body {
    background: linear-gradient(to bottom right, #f9fdfb, #e6f0ff);
    font-family: 'Segoe UI', sans-serif;
    min-height: 100vh;
  }

  h3 {
    font-weight: bold;
    color: #1e90ff;
  }

  .search-box input {
    border: 2px solid #1e90ff;
    border-radius: 8px;
    padding: 10px;
  }

  .client-card .card {
    background-color: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 15px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    height: 100%;
    padding: 1rem;
    text-align: center;
  }

  .client-card .card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
  }

  .client-img {
    width: 75px;
    height: 75px;
    object-fit: cover;
    border-radius: 50%;
    margin-bottom: 10px;
    border: 2px solid #28a745;
  }

  .card-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: #333;
  }

  .card p {
    margin: 0.25rem 0;
    font-size: 0.95rem;
    word-break: break-word;
  }

  .badge-active {
    background-color: #28a745 !important;
    color: white;
  }

  .badge-inactive {
    background-color: #ffc107 !important;
    color: black;
  }

  .badge-blocked {
    background-color: #dc3545 !important;
    color: white;
  }

  .btn-primary {
    background-color: #1e90ff;
    border: none;
  }

  .btn-primary:hover {
    background-color: #0d6efd;
  }

  .btn-success {
    background-color: #28a745;
  }

  .btn-success:hover {
    background-color: #218838;
  }

  .btn-outline-warning:hover {
    background-color: #ffc107;
    color: #000;
  }

  .btn-outline-danger:hover {
    background-color: #dc3545;
    color: #fff;
  }

  button.btn-sm {
    font-weight: 600;
    border-radius: 8px;
    padding: 6px 12px;
  }

  .modal-header {
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
  }

  .modal-title {
    font-weight: 600;
  }

  .modal-content {
    border-radius: 12px;
  }

  @media (max-width: 575px) {
    .btn-sm {
      width: 100%;
    }

    .d-flex.flex-wrap {
      flex-direction: column !important;
      align-items: stretch !important;
    }

    .search-box {
      width: 100%;
    }
  }
</style>


</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
      <h3 class="mb-0">Registered Clients</h3>
      <div class="d-flex gap-2 flex-wrap">
        <select id="statusFilter" class="form-select form-select-sm">
          <option value="">Filter by Status</option>
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
          <option value="blocked">Blocked</option>
        </select>
        <button class="btn btn-primary btn-sm" onclick="exportClientsToPDF()">Export PDF</button>
        <button class="btn btn-success btn-sm" onclick="exportClientsToExcel()">Export Excel</button>
      </div>
    </div>

    <div class="mb-3 search-box">
      <input type="text" id="searchInput" class="form-control" placeholder="ðŸ” Search by name, phone, or ID">
    </div>

    {% if clients %}
    <div class="row" id="clientCards">
     <!-- Paste this where the client card is rendered -->
{% for client in clients %}
<div class="col-md-4 col-sm-6 mb-4 client-card"
     data-client="{{ client.name|lower }} {{ client.phone }} {{ client.client_id }}"
     data-status="{{ client.status }}"
     data-client-id="{{ client._id }}">
  <div class="card h-100 text-center p-3 text-dark" style="cursor: pointer;"
       onclick="window.open('/client/{{ client._id }}', '_blank')">
    <img src="{{ client.image_url or 'https://cdn-icons-png.flaticon.com/256/3135/3135715.png' }}" alt="Profile" class="client-img mx-auto">

    <div class="card-body">
      <h5 class="card-title">{{ client.name }}</h5>
      <p><strong>ID:</strong> <span class="client-id">{{ client.client_id }}</span></p>
      <p><strong>Phone:</strong> <span class="client-phone">{{ client.phone }}</span></p>
      {% if client.location %}
      <p><strong>Location:</strong> <span>{{ client.location }}</span></p>
      {% endif %}
      <p><strong>Status:</strong>
        <span class="badge
          {% if client.status == 'active' %}badge-active
          {% elif client.status == 'inactive' %}badge-inactive
          {% else %}badge-blocked{% endif %} client-status">
          {{ client.status|capitalize }}
        </span>
      </p>
      <p><strong>Registered:</strong> <span class="client-date">{{ client.date_registered }}</span></p>
      <div class="d-flex justify-content-center gap-2 mt-3">
        <button type="button" class="btn btn-sm btn-outline-warning"
                onclick="event.stopPropagation(); editClient('{{ client._id }}', '{{ client.name }}', '{{ client.phone }}', '{{ client.status }}')">
          Edit
        </button>
        <button type="button" class="btn btn-sm btn-outline-danger"
                onclick="event.stopPropagation(); confirmDelete('{{ client._id }}')">
          Delete
        </button>
      </div>
    </div>
  </div>
</div>
{% endfor %}



    </div>
    {% else %}
      <p class="text-muted">No clients found.</p>
    {% endif %}
  </div>

  <!-- Edit Modal -->
  <div class="modal fade" id="editClientModal" tabindex="-1">
    <div class="modal-dialog">
      <form class="modal-content" id="editClientForm">
        <div class="modal-header bg-warning text-white">
          <h5 class="modal-title">Edit Client</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="id" id="editClientId">
          <div class="mb-2"><input type="text" class="form-control" id="editName" name="name" placeholder="Name" required></div>
          <div class="mb-2"><input type="text" class="form-control" id="editPhone" name="phone" placeholder="Phone" required></div>
          <div class="mb-2">
            <select class="form-select" name="status" id="editStatus" required>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
              <option value="blocked">Blocked</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-warning">Save</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Modal -->
  <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">Confirm Delete</h5>
        </div>
        <div class="modal-body">Are you sure you want to delete this client?</div>
        <div class="modal-footer">
          <div id="deletingSpinner" style="display:none;" class="me-auto text-danger small">Deleting...</div>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-danger" id="confirmDeleteBtn">Yes, Delete</button>
        </div>
      </div>
    </div>
  </div>

 <script>
  let clientToDelete = null;

  // Helper: Return only visible cards
  function getVisibleClientCards() {
    return Array.from(document.querySelectorAll('.client-card')).filter(card => card.offsetParent !== null);
  }

  // Search filter
  $('#searchInput').on('keyup', function () {
    const value = $(this).val().toLowerCase();
    $('#clientCards .client-card').each(function () {
      const clientText = $(this).data('client');
      $(this).toggle(clientText.includes(value));
    });
  });

  // Status filter
  $('#statusFilter').on('change', function () {
    const selected = $(this).val();
    $('#clientCards .client-card').each(function () {
      const status = $(this).data('status');
      $(this).toggle(!selected || status === selected);
    });
  });

  // Export to Excel
  function exportClientsToExcel() {
    const rows = [["Client ID", "Name", "Phone", "Status", "Date Registered"]];
    getVisibleClientCards().forEach(card => {
      rows.push([
        card.querySelector('.client-id')?.innerText.trim(),
        card.querySelector('h5')?.innerText.trim(),
        card.querySelector('.client-phone')?.innerText.trim(),
        card.querySelector('.client-status')?.innerText.trim(),
        card.querySelector('.client-date')?.innerText.trim()
      ]);
    });
    const csv = rows.map(e => e.join(",")).join("\n");
    const link = document.createElement("a");
    link.href = "data:text/csv;charset=utf-8," + encodeURIComponent(csv);
    link.download = "client_list.csv";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  // Export to PDF
  function exportClientsToPDF() {
    const visibleCards = getVisibleClientCards();
    const tableHTML = `
      <h4>Registered Clients</h4>
      <table border="1" cellspacing="0" cellpadding="8" width="100%">
        <thead><tr><th>ID</th><th>Name</th><th>Phone</th><th>Status</th><th>Registered</th></tr></thead>
        <tbody>
          ${visibleCards.map(card => `
            <tr>
              <td>${card.querySelector('.client-id').innerText}</td>
              <td>${card.querySelector('h5').innerText}</td>
              <td>${card.querySelector('.client-phone').innerText}</td>
              <td>${card.querySelector('.client-status').innerText}</td>
              <td>${card.querySelector('.client-date').innerText}</td>
            </tr>`).join('')}
        </tbody>
      </table>`;
    const hiddenDiv = document.createElement('div');
    hiddenDiv.innerHTML = tableHTML;
    document.body.appendChild(hiddenDiv);
    html2pdf().from(hiddenDiv).set({
      margin: 0.5,
      filename: 'client_list.pdf',
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
    }).save().then(() => document.body.removeChild(hiddenDiv));
  }

  // Confirm delete
  function confirmDelete(clientId) {
    clientToDelete = clientId;
    new bootstrap.Modal(document.getElementById('deleteConfirmModal')).show();
  }

  // Delete action
  $('#confirmDeleteBtn').click(function () {
    if (!clientToDelete) return;
    $('#deletingSpinner').show();
    $.post(`/clients/delete/${clientToDelete}`, function (res) {
      $('#deletingSpinner').hide();
      if (res.success) {
        $(`[data-client-id="${clientToDelete}"]`).remove();
        bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
      } else {
        alert('Error: ' + (res.error || 'Unable to delete.'));
      }
    });
  });

  // Edit modal fill
  function editClient(id, name, phone, status) {
    $('#editClientId').val(id);
    $('#editName').val(name);
    $('#editPhone').val(phone);
    $('#editStatus').val(status);
    new bootstrap.Modal(document.getElementById('editClientModal')).show();
  }

  // Submit edited form
  $('#editClientForm').on('submit', function (e) {
    e.preventDefault();
    $.post(`/clients/update`, $(this).serialize(), function (res) {
      if (res.success) {
        location.reload();
      } else {
        alert('Update failed: ' + (res.error || 'Unknown error.'));
      }
    });
  });
</script>

</body>
</html>
